generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model DentalLead {
  id          String   @id @default(cuid())
  source      String   @default("contact_sales")
  phone       String?
  email       String?
  pagePath    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  notes       String?
  createdAt   DateTime @default(now())

  @@map("DentalLead")
}

// Demo-only models (tables used only for the DentalScan demo flow)

model DemoDentist {
  id        String        @id @default(cuid())
  name      String
  email     String?
  phone     String?
  createdAt DateTime      @default(now())

  patients  DemoPatient[]
  scans     DemoScan[]

  @@map("demo_dentist")
}

model DemoPatient {
  id        String      @id @default(cuid())
  name      String
  phone     String
  email     String?
  createdAt DateTime    @default(now())

  dentist   DemoDentist @relation(fields: [dentistId], references: [id])
  dentistId String

  scans     DemoScan[]

  @@map("demo_patient")
}

model DemoScan {
  id          String        @id @default(cuid())
  status      String        @default("link_sent") // link_sent | submitted | completed
  imageUrls   Json?
  result      Json?
  createdAt   DateTime      @default(now())
  submittedAt DateTime?
  completedAt DateTime?

  dentist     DemoDentist?  @relation(fields: [dentistId], references: [id])
  dentistId   String?

  patient     DemoPatient?  @relation(fields: [patientId], references: [id])
  patientId   String?

  // NEW: short links associated with this scan
  links       DemoScanLink[]

  @@map("demo_scan")
}

model DemoScanLink {
  id        String      @id @default(cuid())
  code      String      @unique        // e.g. "AB3F9X2K"
  scan      DemoScan    @relation(fields: [scanId], references: [id])
  scanId    String

  dentistId String?
  patientId String?

  createdAt DateTime    @default(now())
  expiresAt DateTime?

  @@map("demo_scan_link")
}

model PartnerWithUs {
  id           String   @id @default(cuid())
  name         String
  email        String
  organization String?
  type         String
  message      String?
  createdAt    DateTime @default(now())

  @@map("PartnerWithUs")
}

// School admin portal models
model School {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  teachers  Teacher[]
  classes   SchoolClass[]
  students  Student[]
  auditLogs AuditLog[]

  @@map("school")
}

model Teacher {
  id           String       @id @default(cuid())
  email        String       @unique
  name         String
  passwordHash String
  school       School       @relation(fields: [schoolId], references: [id])
  schoolId     String
  createdAt    DateTime     @default(now())

  classes      SchoolClass[]

  @@map("teacher")
}

model SchoolClass {
  id          String           @id @default(cuid())
  name        String
  grade       String?
  teacher     Teacher          @relation(fields: [teacherId], references: [id])
  teacherId   String
  school      School           @relation(fields: [schoolId], references: [id])
  schoolId    String
  createdAt   DateTime         @default(now())

  enrollments ClassEnrollment[]
  auditLogs   AuditLog[]

  @@map("school_class")
}

model Student {
  id         String           @id @default(cuid())
  firstName  String
  lastName   String
  school     School           @relation(fields: [schoolId], references: [id])
  schoolId   String
  createdAt  DateTime         @default(now())

  enrollments ClassEnrollment[]
  auditLogs   AuditLog[]

  @@map("student")
}

model ClassEnrollment {
  id              String      @id @default(cuid())
  class           SchoolClass @relation(fields: [classId], references: [id])
  classId         String
  student         Student     @relation(fields: [studentId], references: [id])
  studentId       String
  consent         Boolean     @default(false)
  scanStatus      String      @default("not_completed")
  scanCompletedAt DateTime?
  createdAt       DateTime    @default(now())

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@index([scanStatus])
  @@map("class_enrollment")
}

model AuditLog {
  id           String   @id @default(cuid())
  action       String
  actorId      String?
  actorType    String?
  school       School?  @relation(fields: [schoolId], references: [id])
  schoolId     String?
  class        SchoolClass? @relation(fields: [classId], references: [id])
  classId      String?
  student      Student? @relation(fields: [studentId], references: [id])
  studentId    String?
  resourceType String?
  resourceId   String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([schoolId])
  @@index([classId])
  @@index([studentId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_log")
}
